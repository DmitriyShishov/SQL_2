## Задание
У вас есть доступ к базе данных Отдела продаж (PostgreSQL), куда загружаются данные об ответах менеджеров в сделках в amoCRM. Диалог с каждым клиентом ведётся внутри своей сделки. 
Необходимо: 
	1. Написать SQL-запрос, который будет рассчитывать среднее время ответа для каждого менеджера/пары менеджеров. 
Расчёт должен учитывать следующее: 
• если в диалоге идут несколько сообщений подряд от клиента или менеджера, то при расчёте времени ответа надо учитывать только первое сообщение из каждого блока; 
• менеджеры работают с 09:30 до 00:00, поэтому нерабочее время не должно учитываться в расчёте среднего времени ответа, т.е. если клиент написал в 23:59, а менеджер ответил в 09:30 – время ответа равно одной минуте; 
• ответы на сообщения, пришедшие ночью также нужно учитывать. 
	2. Решить первое задание при помощи Python и библиотеки pandas


## Решение

Q1.  Приводим столбец created_by к типу даты и времени. В тех сообщениях, для которых идентификатор автора отмечен как 0, меняем тип сообщения на входящий. Это видимо системный сбой. Вся информация, что у нас есть, заключается в том, что 0 ВСЕГДА у клиента.

Q2. Здесь мы создадим столбец prev_datetime. Сначала определимся, что будем использовать оконную функцию с группировкой по номеру сделки и с сортировкой по времени сообщения. В такой конфигурации мы проверяем, если тип текущего сообщения не равен типу предыдущего и является исходящим, то для такого объекта создается сохраняется время предыдущего сообщения (входящего). Таким образом мы учитываем, что могут идти несколько сообщения подряд от одного адресата. В таком исполнении также не будут создаваться значения для строк, где первым идет исходящее сообщение.

Q3.  Здесь мы рассчитываем разницу между датой ответа и полученной на предыдущем этапе датой вопроса. 
Для случаев, когда вопрос был получен с полуночи до начала рабочего дня, а ответ отправлен после 09:30:00 утра, разница будет считаться между временем ответа и началом рабочего дня. 
Для случаев, когда вопрос был получен до полуночи, а ответ отправлен на следующий день в рабочее время, разница будет считаться между датой ответа и датой вопрос, и затем также вычитается интервал в 9 часов 30 минут (нерабочее время). 
В остальных случаях просто считается разница между датой ответа и датой вопроса.

Q4. Проанализировав результаты, я пришел к выводу, что лучше будет убрать из выборки случаи, когда ответ менеджера был отправлен вне рабочего времени. Иначе происходят случаи, когда менеджер вышел пораньше на работу, ответил на сообщение до начала рабочего дня, а разница во времени может быть около 9 часов. Стоит также учитывать, что мы в итоге должны получить среднее время ответа, а этот атрибут чувствителен к выбросам.
	Также из выборки мы убираем входящие сообщения (они нам больше не нужны) и те сообщения, для которых значение разницы пусто. Это случаи, когда сделка состоит из одного исходящего сообщения или исходящее сообщение идет первым в сделке.

Q5. Теперь мы можем рассчитать среднее время ответа с группировкой по идентификатору менеджера.

Q6 - Q7.  Переведем значения разницы во времени в минуты. Соединим полученные значения с другими таблицами для получения финальной сводной таблицы. 
